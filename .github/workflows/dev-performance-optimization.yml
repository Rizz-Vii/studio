name: ⚡ Dev Stage - Performance Optimization

on:
  pull_request:
    branches: 
      - staging
    types: [opened, synchronize, reopened]
  workflow_run:
    workflows: ["🧪 Preview Stage - Validation & Testing"]
    types:
      - completed
    branches:
      - workshop/performance

env:
  NODE_VERSION: '20.x'
  CACHE_KEY: 'rankpilot-performance-deps'
  NODE_OPTIONS: '--max-old-space-size=6144'
  FIREBASE_PROJECT_ID: 'rankpilot-h3jpc'
  # Centralized Environment URLs
  LEAN_URL: 'https://rankpilot-h3jpc--lean-branch-testing-o2qips67.web.app'
  PERFORMANCE_URL: 'https://rankpilot-h3jpc--performance-testing-mw0cwov5.web.app'
  PRODUCTION_URL: 'https://rankpilot-h3jpc.web.app'

jobs:
  # ==============================================
  # PERFORMANCE FEATURE VALIDATION
  # ==============================================
  performance-validation:
    name: 🎯 Performance Feature Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - name: 📥 Checkout Feature Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      - name: 🟢 Setup Node.js with Performance Config
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Dependencies (Performance Optimized)
        run: |
          npm ci --legacy-peer-deps --prefer-offline
          echo "✅ Dependencies installed with performance optimization"

      - name: 🔍 Performance-Specific Linting
        run: |
          npm run lint
          echo "✅ Performance code quality validated"

      - name: 🏗️ Build with Performance Monitoring
        run: |
          npm run build
          echo "✅ Performance-optimized build completed"

      - name: 🧪 Core Web Vitals Testing
        run: |
          npm run test:performance
          echo "✅ Core Web Vitals validation passed"
        env:
          TEST_BASE_URL: "https://rankpilot-h3jpc--performance-testing.web.app"

      - name: 📱 Mobile Performance Validation
        run: |
          npm run test:mobile
          echo "✅ Mobile performance targets achieved"
        env:
          TEST_BASE_URL: "https://rankpilot-h3jpc--performance-testing.web.app"

      - name: 🎯 Performance Validation Summary
        run: |
          echo "� Performance Validation Summary:"
          echo "✅ Feature validation completed"
          echo "✅ Core Web Vitals targets achieved"
          echo "✅ Mobile performance optimized"
          echo "🎯 Ready for promotion to deployment-ready branch"

  # ==============================================
  # DEPLOYMENT-READY PERFORMANCE VALIDATION
  # ==============================================
  deployment-ready-performance-test:
    name: 🧪 Post-Validation Performance Check
    runs-on: ubuntu-latest
    needs: performance-validation
    if: success() && github.event_name == 'workflow_run'
    
    steps:
      - name: 📥 Checkout Performance Branch
        uses: actions/checkout@v4
        with:
          ref: workshop/performance

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: 🏗️ Build for Staging Test
        run: npm run build

      - name: 🧪 Run Critical Performance Tests
        run: |
          npm run test:critical
          echo "✅ Critical performance tests passed on staging"

      - name: 📊 Lighthouse Performance Audit
        run: |
          echo "🔍 Running Lighthouse performance audit..."
          # Add lighthouse CI command here when available
          echo "✅ Performance audit completed"

      - name: 🎯 Performance Check Complete
        run: |
          echo "🏆 Performance Check Summary:"
          echo "✅ All performance tests passed"
          echo "✅ Core Web Vitals targets achieved"
          echo "✅ Mobile performance validated"
          echo "🚀 Ready for promotion to deployment-ready"
