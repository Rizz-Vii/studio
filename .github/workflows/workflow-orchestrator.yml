name: ğŸ”„ Workflow Orchestrator - Status Dashboard

on:
  workflow_run:
    workflows: 
      - "ğŸš€ Dev Stage - Workshop Instant Preview"
      - "ğŸ§ª Preview Stage - Validation & Testing"
      - "âš¡ Dev Stage - Performance Optimization"
      - "ğŸ¯ Main Hub - Performance to Deployment-Ready Promotion"
      - "ğŸ¯ Integration Stage - Deployment-Ready to Staging Auto-Deploy"
    types: [requested, in_progress, completed]

env:
  NODE_VERSION: '20.x'

jobs:
  workflow-status:
    name: ğŸ“Š Workflow Status Monitor
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Log Workflow Status
        run: |
          echo "ğŸ”„ WORKFLOW ORCHESTRATOR STATUS"
          echo "================================="
          echo "ğŸ“ Workflow: ${{ github.event.workflow_run.name }}"
          echo "ğŸ¯ Status: ${{ github.event.workflow_run.status }}"
          echo "âœ… Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "ğŸ• Started: ${{ github.event.workflow_run.created_at }}"
          echo "ğŸ”— URL: ${{ github.event.workflow_run.html_url }}"
          echo ""
          
          # Determine next step based on current workflow
          case "${{ github.event.workflow_run.name }}" in
            "ğŸš€ Dev Stage - Workshop Instant Preview")
              if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                echo "â¡ï¸ Next: Preview Stage - Validation & Testing will trigger"
              fi
              ;;
            "ğŸ§ª Preview Stage - Validation & Testing")
              if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                echo "â¡ï¸ Next: Performance Optimization will trigger"
              fi
              ;;
            "âš¡ Dev Stage - Performance Optimization")
              if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                echo "â¡ï¸ Next: Performance to Deployment-Ready Promotion will trigger"
              fi
              ;;
            "ğŸ¯ Main Hub - Performance to Deployment-Ready Promotion")
              if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                echo "â¡ï¸ Next: Deployment-Ready to Staging Auto-Deploy will trigger"
              fi
              ;;
            "ğŸ¯ Integration Stage - Deployment-Ready to Staging Auto-Deploy")
              if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                echo "â¡ï¸ Next: Manual PR review required for production deployment"
              fi
              ;;
          esac

      - name: ğŸš¨ Alert on Failures
        if: github.event.workflow_run.conclusion == 'failure'
        run: |
          echo "ğŸš¨ WORKFLOW FAILURE DETECTED"
          echo "============================"
          echo "âŒ Failed Workflow: ${{ github.event.workflow_run.name }}"
          echo "ğŸŒ¿ Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "ğŸ”— Details: ${{ github.event.workflow_run.html_url }}"
          echo ""
          echo "ğŸ› ï¸ Troubleshooting Steps:"
          echo "1. Check workflow logs for specific error details"
          echo "2. Verify all environment variables are properly set"
          echo "3. Ensure Firebase project permissions are correct"
          echo "4. Check for any package.json or dependency issues"
          echo "5. Verify Playwright configurations are valid"
          
          # Set failure status for monitoring
          exit 1

  pipeline-health:
    name: ğŸ¥ Pipeline Health Check
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Validate Workflow Configuration
        run: |
          echo "ğŸ” PIPELINE HEALTH CHECK"
          echo "========================"
          
          # Check for common workflow issues
          echo "ğŸ“‹ Validating workflow files..."
          find .github/workflows -name "*.yml" -exec echo "âœ“ {}" \;
          
          # Check for package.json test scripts
          echo "ğŸ“‹ Validating test scripts..."
          if grep -q "test:lean-critical" package.json; then
            echo "âœ… Lean critical tests configured"
          else
            echo "âš ï¸ Lean critical tests not found"
          fi
          
          if grep -q "test:lean-mobile" package.json; then
            echo "âœ… Lean mobile tests configured"  
          else
            echo "âš ï¸ Lean mobile tests not found"
          fi
          
          # Check for Playwright configurations
          echo "ğŸ“‹ Validating Playwright configs..."
          ls playwright.config*.ts | head -5 | while read config; do
            echo "âœ“ $config"
          done
          
          echo "âœ… Pipeline health check completed"
