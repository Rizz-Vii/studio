name: ğŸš€ Feature/Performance Branch CI/CD Pipeline

on:
  push:
    branches: 
      - feature/performance-optimization-mobile-enhancement
      - feature/performance-*
  pull_request:
    branches: 
      - master
      - preDeploy
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'
  CACHE_KEY: 'rankpilot-performance-deps'
  NODE_OPTIONS: '--max-old-space-size=6144'

jobs:
  # ==============================================
  # PERFORMANCE FEATURE VALIDATION
  # ==============================================
  performance-feature-validation:
    name: ğŸ¯ Performance Feature Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Feature Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      - name: ğŸŸ¢ Setup Node.js with Performance Config
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies (Performance Optimized)
        run: |
          npm ci --legacy-peer-deps --prefer-offline
          echo "âœ… Dependencies installed with performance optimization"

      - name: ğŸ” Performance-Specific Linting
        run: |
          npm run lint
          echo "âœ… Performance code quality validated"

      - name: ğŸ—ï¸ Build with Performance Monitoring
        run: |
          npm run build:production
          echo "âœ… Performance-optimized build completed"
        env:
          ANALYZE: true

      - name: ğŸ“Š Bundle Analysis
        run: |
          npm run analyze
          echo "âœ… Bundle size analysis completed"

  # ==============================================
  # CORE WEB VITALS TESTING
  # ==============================================
  core-web-vitals:
    name: ğŸ“ˆ Core Web Vitals Testing
    runs-on: ubuntu-latest
    needs: performance-feature-validation
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ—ï¸ Build for Performance Testing
        run: npm run build:production

      - name: ğŸš€ Start Performance Server
        run: |
          npm start &
          sleep 15
          echo "âœ… Performance server started"

      - name: ğŸŒ Lighthouse Performance Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ğŸ“± Mobile Performance Testing
        run: |
          npx lighthouse http://localhost:3000 --chrome-flags="--headless" --emulated-form-factor=mobile --throttling-method=devtools --output=json --output-path=./mobile-performance.json
          echo "âœ… Mobile performance testing completed"

      - name: ğŸ“Š Performance Metrics Analysis
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./mobile-performance.json'));
            const metrics = report.lhr.audits;
            
            console.log('ğŸ“Š Core Web Vitals Results:');
            console.log('LCP (Largest Contentful Paint):', metrics['largest-contentful-paint'].displayValue);
            console.log('FID (First Input Delay):', metrics['max-potential-fid'].displayValue);
            console.log('CLS (Cumulative Layout Shift):', metrics['cumulative-layout-shift'].displayValue);
            console.log('Performance Score:', report.lhr.categories.performance.score * 100);
            
            // Fail if performance is below threshold
            if (report.lhr.categories.performance.score < 0.9) {
              console.error('âŒ Performance score below 90%');
              process.exit(1);
            }
            console.log('âœ… Performance targets met');
          "

  # ==============================================
  # MOBILE-FIRST TESTING
  # ==============================================
  mobile-optimization-testing:
    name: ğŸ“± Mobile Optimization Testing
    runs-on: ubuntu-latest
    needs: performance-feature-validation
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ—ï¸ Build Application
        run: npm run build

      - name: ğŸ“± Mobile-Specific Tests
        run: |
          npm run test:mobile
          echo "âœ… Mobile optimization tests completed"

      - name: ğŸ¯ Touch Target Validation
        run: |
          npm run test:accessibility
          echo "âœ… Touch target accessibility validated"

      - name: ğŸ“Š Mobile Performance Validation
        run: |
          npm run test:performance
          echo "âœ… Mobile performance validated"

  # ==============================================
  # ENHANCED TESTING SUITE
  # ==============================================
  performance-enhanced-testing:
    name: ğŸ§ª Performance Enhanced Testing
    runs-on: ubuntu-latest
    needs: core-web-vitals
    
    strategy:
      matrix:
        test-type: [critical, high-memory, warmed]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js with High Memory
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ§ª Run Performance Test Suite
        run: |
          case "${{ matrix.test-type }}" in
            "critical")
              npm run test:critical
              ;;
            "high-memory")
              npm run test:production
              ;;
            "warmed")
              npm run test:production
              ;;
          esac
          echo "âœ… ${{ matrix.test-type }} tests completed"
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'

  # ==============================================
  # SECURITY & QUALITY GATES
  # ==============================================
  security-performance-audit:
    name: ğŸ”’ Security & Performance Audit
    runs-on: ubuntu-latest
    needs: performance-feature-validation
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ” Security Audit
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed"

      - name: ğŸ›¡ï¸ Performance Security Check
        run: |
          npm run security-check
          echo "âœ… Performance security validated"

      - name: ğŸ” Environment Validation
        run: |
          npm run verify-env
          echo "âœ… Environment configuration validated"

  # ==============================================
  # BRANCH MERGE READINESS
  # ==============================================
  merge-readiness-check:
    name: ğŸ¯ Merge Readiness Validation
    runs-on: ubuntu-latest
    needs: [core-web-vitals, mobile-optimization-testing, performance-enhanced-testing, security-performance-audit]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ—ï¸ Final Build Validation
        run: |
          npm run build:production
          echo "âœ… Final build validation completed"

      - name: ğŸ“Š Performance Metrics Report
        run: |
          echo "ğŸ“Š Performance Branch Validation Summary:"
          echo "âœ… Core Web Vitals Testing: PASSED"
          echo "âœ… Mobile Optimization: PASSED"  
          echo "âœ… Enhanced Testing Suite: PASSED"
          echo "âœ… Security & Performance Audit: PASSED"
          echo "ğŸ¯ Branch ready for merge to preDeploy"

      - name: ğŸš€ Pre-Deploy Branch Check
        if: github.event_name == 'pull_request' && github.base_ref == 'preDeploy'
        run: |
          echo "ğŸ¯ Validating for preDeploy branch merge..."
          npm run test:production
          echo "âœ… preDeploy merge validation completed"

  # ==============================================
  # PREVIEW CHANNEL DEPLOYMENT
  # ==============================================
  preview-channel-deployment:
    name: ğŸ”„ Deploy to Performance Testing Channel
    runs-on: ubuntu-latest
    needs: merge-readiness-check
    if: github.ref == 'refs/heads/feature/performance-optimization-mobile-enhancement' && github.event_name == 'push'
    
    steps:
      - name: ğŸš€ Deploy to Preview Channel
        uses: ./.github/workflows/preview-channel-deploy.yml
        with:
          channel-id: 'performance-testing'
          branch-ref: ${{ github.ref }}

      - name: ğŸ“Š Preview Channel Integration
        run: |
          echo "ğŸ¯ Performance Testing Channel Integration:"
          echo "ğŸ”— Live URL: https://rankpilot-h3jpc--performance-testing-mw0cwov5.web.app/"
          echo "ğŸ“Š Core Web Vitals validation in progress..."
          echo "ğŸ“± Mobile optimization testing active"
          echo "âœ… Preview channel ready for performance validation"

  # ==============================================
  # AUTOMATIC MERGE TO PREDEPLOY (Updated)
  # ==============================================
  auto-merge-to-predeploy:
    name: ğŸ”„ Auto-Merge to preDeploy
    runs-on: ubuntu-latest
    needs: [merge-readiness-check, preview-channel-deployment]
    if: github.ref == 'refs/heads/feature/performance-optimization-mobile-enhancement' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout preDeploy
        uses: actions/checkout@v4
        with:
          ref: preDeploy
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”„ Merge Performance Branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git merge origin/feature/performance-optimization-mobile-enhancement --no-ff -m "ğŸš€ Auto-merge: Performance optimization features validated and ready for deployment"
          git push origin preDeploy
          echo "âœ… Performance features merged to preDeploy branch"

      - name: ğŸ“ Create Merge Summary
        run: |
          echo "ğŸ‰ Performance optimization features successfully merged!"
          echo "ğŸ“Š All quality gates passed:"
          echo "  âœ… Core Web Vitals validation"
          echo "  âœ… Mobile optimization testing"
          echo "  âœ… Enhanced testing suite"
          echo "  âœ… Security and performance audit"
          echo "  âœ… Preview channel deployment: https://rankpilot-h3jpc--performance-testing-mw0cwov5.web.app/"
          echo "ğŸš€ preDeploy branch updated and ready for production deployment"

  # ==============================================
  # NOTIFICATION & REPORTING
  # ==============================================
  notification:
    name: ğŸ“¢ Performance Validation Report
    runs-on: ubuntu-latest
    needs: [merge-readiness-check]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Performance Report
        run: |
          echo "ğŸ“ˆ Performance Branch CI/CD Report"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Validation Status: ${{ needs.merge-readiness-check.result }}"
          
          if [ "${{ needs.merge-readiness-check.result }}" == "success" ]; then
            echo "âœ… All performance validations passed"
            echo "ğŸš€ Branch ready for production deployment"
          else
            echo "âŒ Performance validation failed"
            echo "ğŸ”§ Review failed jobs and address issues"
          fi

      - name: ğŸ“ Performance Metrics Summary
        run: |
          echo "ğŸ“Š Performance Optimization Summary:"
          echo "ğŸ¯ Core Web Vitals: Validated for mobile and desktop"
          echo "ğŸ“± Mobile Performance: Optimized for 48px touch targets"
          echo "ğŸ§ª Enhanced Testing: High-memory and warmed cache validation"
          echo "ğŸ”’ Security: Performance security audit completed"
          echo "âœ… Ready for merge to preDeploy branch"
