name: ï¿½ Integration Stage - Deployment to Staging Promotion

on:
  workflow_run:
    workflows: 
      - "Development Hyperloop CI/CD"
      - "ðŸš€ Feature/Performance Branch CI/CD Pipeline"
    types: [completed]
    branches: [workshop/deployment-ready]

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT_ID: 'rankpilot-h3jpc'

jobs:
  auto-merge-to-staging:
    name: ðŸŽ¯ Auto-Merge to Staging
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' && 
      github.event.workflow_run.head_branch == 'workshop/deployment-ready'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” Get Deployment-Ready Info
        id: deployment-info
        run: |
          echo "source_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          
          # Get the latest merged branches from commit messages
          git checkout workshop/deployment-ready
          MERGED_BRANCHES=$(git log --oneline -10 --grep="Auto-merge:" | head -5)
          echo "merged_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$MERGED_BRANCHES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: ðŸ”„ Auto-Merge to Staging
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Checkout staging
          git checkout staging
          git pull origin staging
          
          # Merge deployment-ready
          echo "ðŸ”„ Merging workshop/deployment-ready into staging"
          git merge origin/workshop/deployment-ready --no-ff -m "ðŸŽ¯ Auto-merge: deployment-ready â†’ staging

          âœ… All comprehensive tests passed
          âœ… Deployment readiness validated
          ðŸ“¦ SHA: ${{ steps.deployment-info.outputs.source_sha }}
          
          ðŸ“‹ Recent merges included:
          ${{ steps.deployment-info.outputs.merged_summary }}
          
          ðŸ¤– Auto-merged for final pre-live validation"
          
          # Push to trigger staging workflow
          git push origin staging
      
      - name: ðŸ“Š Report Staging Merge
        run: |
          echo "âœ… Successfully auto-merged workshop/deployment-ready â†’ staging"
          echo "ðŸš€ Triggering final pre-live tests and validation"

  trigger-final-validation:
    name: ðŸ”’ Trigger Final Pre-Live Validation
    runs-on: ubuntu-latest
    needs: auto-merge-to-staging
    
    steps:
      - name: ðŸ”” Notify Final Testing Started
        run: |
          echo "ðŸ”’ Final pre-live validation pipeline triggered for staging"
          echo "ðŸ“‹ This will run production-level security and quality tests"
