name: ğŸ¯ Integration Stage - Deployment-Ready to Staging Auto-Deploy

on:
  workflow_run:
    workflows: 
      - "ğŸ¯ Main Hub - Performance to Deployment-Ready Promotion"
    types: [completed]
    branches: 
      - workshop/deployment-ready

  push:
    branches:
      - workshop/deployment-ready

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT_ID: 'rankpilot-h3jpc'
  # Centralized Environment URLs
  LEAN_URL: 'https://rankpilot-h3jpc--lean-branch-testing-o2qips67.web.app'
  PERFORMANCE_URL: 'https://rankpilot-h3jpc--performance-testing-mw0cwov5.web.app'
  PRODUCTION_URL: 'https://rankpilot-h3jpc.web.app'

jobs:
  final-validation-testing:
    name: ğŸ§ª Final Validation Testing
    runs-on: ubuntu-latest-4-cores
    timeout-minutes: 30
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Deployment-Ready
        uses: actions/checkout@v4
        with:
          ref: workshop/deployment-ready
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --legacy-peer-deps
          echo "âœ… Dependencies installed for final validation"

      - name: ğŸ—ï¸ Production-Ready Build
        run: |
          npm run build
          echo "âœ… Production-ready build successful"

      - name: ğŸ§ª Full Integration Test Suite
        run: |
          npm run test:role-based
          npm run test:critical
          npm run test:performance
          echo "âœ… All final validation tests passed"

      - name: ğŸ›¡ï¸ Production Security Validation
        run: |
          npm run lint
          npm run type-check
          echo "âœ… Production security validation passed"

      - name: ğŸ“Š Final Validation Report
        run: |
          echo "ğŸ¯ FINAL VALIDATION TESTING COMPLETE"
          echo "âœ… All integrations validated for production"
          echo "âœ… Performance benchmarks met"
          echo "âœ… Security standards confirmed"
          echo "ğŸš€ Ready for staging deployment"

  auto-deploy-to-staging:
    name: ğŸš€ Auto-Deploy to Staging
    runs-on: ubuntu-latest
    needs: final-validation-testing
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Deploy to Staging
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Checkout staging
          git checkout staging
          git pull origin staging
          
          # Merge deployment-ready with all final validations
          echo "ğŸš€ Deploying workshop/deployment-ready â†’ staging (LIVE-COPY/BACKUP)"
          git merge origin/workshop/deployment-ready --no-ff -m "ğŸš€ Auto-deploy: deployment-ready â†’ staging (LIVE-COPY/BACKUP)

          âœ… Final validation testing PASSED
          âœ… All integrations production-ready
          âœ… Performance benchmarks confirmed
          âœ… Security standards validated
          ğŸ¯ STAGING: Live-copy deployment ready for production"
          
          # Push to trigger staging environment deployment
          git push origin staging

      - name: ğŸ“Š Report Deployment Success
        run: |
          echo "ğŸ¯ DEPLOYMENT SUCCESSFUL: deployment-ready â†’ staging (LIVE-COPY/BACKUP)"
          echo "âœ… All validations passed and deployed"
          echo "ğŸš€ Staging environment ready for production promotion"
