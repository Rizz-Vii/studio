name: 🎯 Integration Stage - Deployment-Ready to Staging Auto-Deploy

on:
  workflow_run:
    workflows: 
      - "🎯 Main Hub - Performance to Deployment-Ready Promotion"
    types: [completed]
    branches: 
      - workshop/deployment-ready

  push:
    branches:
      - workshop/deployment-ready

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT_ID: 'rankpilot-h3jpc'
  # Centralized Environment URLs
  LEAN_URL: 'https://rankpilot-h3jpc--lean-branch-testing-o2qips67.web.app'
  PERFORMANCE_URL: 'https://rankpilot-h3jpc--performance-testing-mw0cwov5.web.app'
  PRODUCTION_URL: 'https://rankpilot-h3jpc.web.app'

jobs:
  final-validation-testing:
    name: 🧪 Final Validation Testing
    runs-on: ubuntu-latest-4-cores
    timeout-minutes: 30
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    
    steps:
      - name: 📥 Checkout Deployment-Ready
        uses: actions/checkout@v4
        with:
          ref: workshop/deployment-ready
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: |
          npm ci --legacy-peer-deps
          echo "✅ Dependencies installed for final validation"

      - name: 🏗️ Production-Ready Build
        run: |
          npm run build
          echo "✅ Production-ready build successful"

      - name: 🧪 Full Integration Test Suite
        run: |
          npm run test:role-based
          npm run test:critical
          npm run test:performance
          echo "✅ All final validation tests passed"

      - name: 🛡️ Production Security Validation
        run: |
          npm run lint
          npm run type-check
          echo "✅ Production security validation passed"

      - name: 📊 Final Validation Report
        run: |
          echo "🎯 FINAL VALIDATION TESTING COMPLETE"
          echo "✅ All integrations validated for production"
          echo "✅ Performance benchmarks met"
          echo "✅ Security standards confirmed"
          echo "🚀 Ready for staging deployment"

  auto-deploy-to-staging:
    name: 🚀 Auto-Deploy to Staging
    runs-on: ubuntu-latest
    needs: final-validation-testing
    if: success()
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🚀 Deploy to Staging
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Checkout staging
          git checkout staging
          git pull origin staging
          
          # Merge deployment-ready with all final validations
          echo "🚀 Deploying workshop/deployment-ready → staging (LIVE-COPY/BACKUP)"
          git merge origin/workshop/deployment-ready --no-ff -m "🚀 Auto-deploy: deployment-ready → staging (LIVE-COPY/BACKUP)

          ✅ Final validation testing PASSED
          ✅ All integrations production-ready
          ✅ Performance benchmarks confirmed
          ✅ Security standards validated
          🎯 STAGING: Live-copy deployment ready for production"
          
          # Push to trigger staging environment deployment
          git push origin staging

      - name: 📊 Report Deployment Success
        run: |
          echo "🎯 DEPLOYMENT SUCCESSFUL: deployment-ready → staging (LIVE-COPY/BACKUP)"
          echo "✅ All validations passed and deployed"
          echo "🚀 Staging environment ready for production promotion"
