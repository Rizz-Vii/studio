name: ğŸš€ Pre-Deployment Security & Quality Pipeline

on:
  push:
    branches: [staging]
  pull_request:
    branches: [staging]

env:
  NODE_VERSION: '20.x'
  CACHE_KEY: 'rankpilot-deps'

jobs:
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ” Security Audit
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed"

      - name: ğŸ›¡ï¸ Dependency Vulnerability Check
        run: |
          npx audit-ci --moderate
          echo "âœ… Dependency vulnerabilities checked"

      - name: ğŸ” Secret Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  code-quality:
    name: ğŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”§ TypeScript Check
        run: npm run type-check

      - name: ğŸ¨ ESLint Analysis
        run: npm run lint:check

      - name: ğŸ’„ Prettier Check
        run: npm run format:check

      - name: ğŸ—ï¸ Build Test
        run: npm run build

  performance-audit:
    name: âš¡ Performance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ—ï¸ Build for Production
        run: npm run build

      - name: ğŸš€ Start Server
        run: |
          npm start &
          sleep 10
          echo "âœ… Server started for performance testing"

      - name: ğŸŒ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  accessibility-audit:
    name: â™¿ Accessibility Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ—ï¸ Build Application
        run: npm run build

      - name: ğŸš€ Start Server
        run: |
          npm start &
          sleep 10

      - name: â™¿ WCAG Compliance Check
        run: |
          npx @axe-core/cli http://localhost:3000 --exit
          echo "âœ… Accessibility audit completed"

  test-comprehensive:
    name: ğŸ§ª Comprehensive Testing
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-suite: [unit, integration, e2e, mobile, performance]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ­ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ğŸ§ª Run Test Suite - ${{ matrix.test-suite }}
        run: |
          case "${{ matrix.test-suite }}" in
            "unit")
              npm run test:unit
              ;;
            "integration")
              npm run test:integration
              ;;
            "e2e")
              npm run test:e2e
              ;;
            "mobile")
              npm run test:mobile
              ;;
            "performance")
              npm run test:performance
              ;;
          esac

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            playwright-report/
            test-results/

  mobile-optimization:
    name: ğŸ“± Mobile Optimization Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ—ï¸ Build Application
        run: npm run build

      - name: ğŸ“± Mobile Performance Audit
        run: |
          npm start &
          sleep 10
          npx lighthouse http://localhost:3000 --preset=mobile --output=json --output-path=mobile-audit.json
          echo "âœ… Mobile optimization check completed"

      - name: ğŸ“Š Upload Mobile Audit
        uses: actions/upload-artifact@v4
        with:
          name: mobile-performance-audit
          path: mobile-audit.json

  security-sast:
    name: ğŸ” Static Application Security Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”’ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  deployment-readiness:
    name: ğŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, performance-audit, accessibility-audit, test-comprehensive, mobile-optimization, security-sast]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”§ Environment Validation
        run: |
          echo "ğŸ” Validating environment configuration..."
          # Check required environment variables are defined
          if [ -z "$NEXT_PUBLIC_FIREBASE_API_KEY" ]; then
            echo "âŒ Missing NEXT_PUBLIC_FIREBASE_API_KEY"
            exit 1
          fi
          echo "âœ… Environment validation passed"

      - name: ğŸ—ï¸ Production Build
        run: npm run build

      - name: ğŸ§ª Build Verification
        run: |
          echo "ğŸ” Verifying build artifacts..."
          if [ ! -d ".next" ]; then
            echo "âŒ Build directory not found"
            exit 1
          fi
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ Build ID not found"
            exit 1
          fi
          echo "âœ… Build verification passed"

      - name: ğŸ“Š Bundle Analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          npx next-bundle-analyzer
          echo "âœ… Bundle analysis completed"

      - name: ğŸ¯ Performance Budget Check
        run: |
          echo "ğŸ¯ Checking performance budgets..."
          # Check if bundle size is within acceptable limits
          BUNDLE_SIZE=$(du -sk .next/static | cut -f1)
          if [ $BUNDLE_SIZE -gt 10240 ]; then  # 10MB limit
            echo "âŒ Bundle size exceeds limit: ${BUNDLE_SIZE}KB"
            exit 1
          fi
          echo "âœ… Performance budget check passed"

      - name: ğŸ”’ Security Configuration Check
        run: |
          echo "ğŸ”’ Checking security configuration..."
          # Verify security headers configuration
          if ! grep -q "Content-Security-Policy" next.config.ts; then
            echo "âš ï¸ CSP headers not configured"
          fi
          echo "âœ… Security configuration check completed"

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "ğŸ‰ PRE-DEPLOYMENT CHECKS SUMMARY"
          echo "=================================="
          echo "âœ… Security Audit: PASSED"
          echo "âœ… Code Quality: PASSED"
          echo "âœ… Performance Audit: PASSED"
          echo "âœ… Accessibility Audit: PASSED"
          echo "âœ… Comprehensive Testing: PASSED"
          echo "âœ… Mobile Optimization: PASSED"
          echo "âœ… SAST Scanning: PASSED"
          echo "âœ… Environment Validation: PASSED"
          echo "âœ… Build Verification: PASSED"
          echo "âœ… Bundle Analysis: PASSED"
          echo "âœ… Performance Budget: PASSED"
          echo "âœ… Security Configuration: PASSED"
          echo ""
          echo "ğŸš€ DEPLOYMENT READY!"
          echo "This branch is ready for production deployment."

  notify-deployment-ready:
    name: ğŸ“¢ Deployment Ready Notification
    runs-on: ubuntu-latest
    needs: [deployment-readiness]
    if: success()
    
    steps:
      - name: ğŸ“¢ Success Notification
        run: |
          echo "ğŸ‰ RankPilot preDeploy Branch - DEPLOYMENT READY!"
          echo "All quality gates have been passed successfully."
          echo "The application is ready for production deployment."
          echo ""
          echo "ğŸ“Š Quality Metrics:"
          echo "- Security: âœ… PASSED"
          echo "- Performance: âœ… PASSED" 
          echo "- Accessibility: âœ… PASSED"
          echo "- Testing: âœ… PASSED"
          echo "- Code Quality: âœ… PASSED"
          echo ""
          echo "ğŸš€ Ready to deploy to production!"

  notify-deployment-failed:
    name: âŒ Deployment Failed Notification
    runs-on: ubuntu-latest
    needs: [deployment-readiness]
    if: failure()
    
    steps:
      - name: âŒ Failure Notification
        run: |
          echo "âŒ RankPilot preDeploy Branch - DEPLOYMENT BLOCKED!"
          echo "One or more quality gates have failed."
          echo "Please review the failed checks and fix issues before deployment."
          echo ""
          echo "ğŸ” Check the following areas:"
          echo "- Security vulnerabilities"
          echo "- Performance regressions"
          echo "- Accessibility compliance"
          echo "- Test failures"
          echo "- Code quality issues"
          echo ""
          echo "âš ï¸ Deployment is blocked until all issues are resolved."
