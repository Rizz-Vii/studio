name: ğŸ¯ Main Hub - Performance to Deployment-Ready Promotion

on:
  workflow_run:
    workflows: 
      - "âš¡ Dev Stage - Performance Optimization"
    types: [completed]
    branches: 
      - workshop/performance

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT_ID: 'rankpilot-h3jpc'
  # Centralized Environment URLs
  LEAN_URL: 'https://rankpilot-h3jpc--lean-branch-testing-o2qips67.web.app'
  PERFORMANCE_URL: 'https://rankpilot-h3jpc--performance-testing-mw0cwov5.web.app'
  PRODUCTION_URL: 'https://rankpilot-h3jpc.web.app'

jobs:
  comprehensive-integration-testing:
    name: ğŸ§ª Comprehensive Integration Testing
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout Performance (Main Hub)
        uses: actions/checkout@v4
        with:
          ref: workshop/performance
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --legacy-peer-deps
          echo "âœ… Dependencies installed for comprehensive testing"

      - name: ğŸ—ï¸ Build Integration
        run: |
          npm run build
          echo "âœ… Build successful - all integrations working"

      - name: ğŸ§ª Run Full Test Suite
        run: |
          npm run test:critical
          npm run test:role-based
          npm run test:performance
          npm run test:mobile
          echo "âœ… All comprehensive tests passed"

      - name: ğŸ›¡ï¸ Security & Quality Validation
        run: |
          npm run lint
          npm run type-check
          echo "âœ… Security and quality validation passed"

      - name: ğŸ“Š Integration Test Report
        run: |
          echo "ğŸ¯ COMPREHENSIVE INTEGRATION TESTING COMPLETE"
          echo "âœ… All workshop integrations validated"
          echo "âœ… Performance optimization confirmed"
          echo "âœ… Security and quality standards met"
          echo "ğŸš€ Ready for deployment-ready promotion"

  auto-promote-to-deployment-ready:
    name: ğŸš€ Auto-Promote to Deployment-Ready
    runs-on: ubuntu-latest
    needs: comprehensive-integration-testing
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Promote to Deployment-Ready
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Checkout deployment-ready
          git checkout workshop/deployment-ready
          git pull origin workshop/deployment-ready
          
          # Merge performance (main hub) with all integrations
          echo "ğŸš€ Promoting workshop/performance (MAIN HUB) â†’ workshop/deployment-ready"
          git merge origin/workshop/performance --no-ff -m "ğŸš€ Auto-promote: performance (MAIN HUB) â†’ deployment-ready

          âœ… Comprehensive integration testing PASSED
          âœ… All workshop features successfully integrated
          âœ… Performance optimization validated
          âœ… Security and quality standards confirmed
          ğŸ¯ DEPLOYMENT-READY: Final validation before staging"
          
          # Push to trigger final deployment validation
          git push origin workshop/deployment-ready

      - name: ğŸ“Š Report Promotion Success
        run: |
          echo "ğŸ¯ PROMOTION SUCCESSFUL: performance (MAIN HUB) â†’ deployment-ready"
          echo "âœ… All integrations validated and consolidated"
          echo "ğŸš€ Triggering final deployment validation tests"
