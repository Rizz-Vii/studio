<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Data Review</title>
    <link rel="stylesheet" href="migration-styles.css">
    <style>
        .user-card {
            background: #2d2d30;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .user-header {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .collection-info {
            background: #1e1e1e;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #0066cc;
        }
        .summary-card {
            background: #2d4a2d;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .tier-free { background: #666; color: white; }
        .tier-starter { background: #2196F3; color: white; }
        .tier-agency { background: #FF9800; color: white; }
        .tier-enterprise { background: #9C27B0; color: white; }
        .tier-admin { background: #F44336; color: white; }
    </style>
</head>
<body>
    <h1>üîç User Data Structure Review</h1>
    <p>Comprehensive analysis of all users and their stored data.</p>
    
    <button onclick="reviewUsers()">Review All Users</button>
    
    <div id="summary"></div>
    <div id="output"></div>

    <script>
        async function reviewUsers() {
            const output = document.getElementById('output');
            const summary = document.getElementById('summary');
            
            output.textContent = 'üöÄ Analyzing user data structures...\n';
            
            try {
                const response = await fetch('/api/review-users', {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Display summary
                    summary.innerHTML = `
                        <div class="summary-card">
                            <h2>üìä Database Summary</h2>
                            <p><strong>Total Users:</strong> ${result.summary.totalUsers}</p>
                            <p><strong>Subscription Tiers:</strong></p>
                            <ul>
                                ${Object.entries(result.summary.subscriptionTiers).map(([tier, count]) => 
                                    `<li>${tier}: ${count} users <span class="tier-badge tier-${tier}">${tier}</span></li>`
                                ).join('')}
                            </ul>
                            
                            <h3>üîç Tier Consistency Analysis</h3>
                            <p><strong>Consistent Users:</strong> ${result.summary.tierConsistency.consistent}</p>
                            <p><strong>Inconsistent Users:</strong> ${result.summary.tierConsistency.inconsistent}</p>
                            ${Object.keys(result.summary.tierConsistency.commonIssues).length > 0 ? `
                                <p><strong>Common Issues:</strong></p>
                                <ul>
                                    ${Object.entries(result.summary.tierConsistency.commonIssues).map(([issue, count]) => 
                                        `<li>${issue} (${count} users)</li>`
                                    ).join('')}
                                </ul>
                            ` : ''}
                            
                            <h3>üë• Role & Plan Analysis</h3>
                            <p><strong>Users with Role:</strong> ${result.summary.roleAnalysis.usersWithRole}</p>
                            <p><strong>Users with Plan:</strong> ${result.summary.roleAnalysis.usersWithPlan}</p>
                            <p><strong>Users with PlanType:</strong> ${result.summary.roleAnalysis.usersWithPlanType}</p>
                            <p><strong>Users with Quotas:</strong> ${result.summary.roleAnalysis.usersWithQuotas}</p>
                            
                            <p><strong>Total Activities:</strong> ${result.summary.totalActivities}</p>
                            <p><strong>Activity Types:</strong> ${result.summary.activityTypes.join(', ')}</p>
                        </div>
                    `;
                    
                    // Display individual users
                    output.innerHTML = result.users.map(user => `
                        <div class="user-card">
                            <div class="user-header">
                                üë§ ${user.userData.displayName || user.userData.email || user.userId}
                                <span class="tier-badge tier-${user.userData.subscriptionTier || 'free'}">
                                    ${user.userData.subscriptionTier || 'free'}
                                </span>
                                ${!user.tierAnalysis.isConsistent ? '<span style="color: #f44336; margin-left: 10px;">‚ö†Ô∏è INCONSISTENT</span>' : ''}
                            </div>
                            
                            <p><strong>Email:</strong> ${user.userData.email || 'N/A'}</p>
                            <p><strong>Created:</strong> ${user.userData.createdAt ? new Date(user.userData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Last Login:</strong> ${user.userData.lastLoginAt ? new Date(user.userData.lastLoginAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                            
                            <div class="collection-info">
                                <strong>üéØ Tier Analysis:</strong><br>
                                Subscription Tier: ${user.tierAnalysis.currentTier}<br>
                                ${user.userData.role ? `Role: ${user.userData.role}<br>` : ''}
                                ${user.userData.plan ? `Plan: ${user.userData.plan}<br>` : ''}
                                ${user.userData.planType ? `Plan Type: ${user.userData.planType}<br>` : ''}
                                Has Quotas: ${user.tierAnalysis.hasQuotas ? 'Yes' : 'No'}<br>
                                ${user.tierAnalysis.inconsistencies.length > 0 ? `
                                    <span style="color: #f44336;">Issues:</span><br>
                                    ${user.tierAnalysis.inconsistencies.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
                                ` : '<span style="color: #4CAF50;">‚úì Consistent</span>'}
                            </div>
                            
                            ${user.userData.quotas ? `
                                <div class="collection-info">
                                    <strong>üìä Quotas:</strong><br>
                                    ${Object.entries(user.userData.quotas).map(([key, value]) => 
                                        `${key}: ${value}`
                                    ).join('<br>')}
                                </div>
                            ` : ''}
                            
                            <div class="collection-info">
                                <strong>üìù Activities:</strong> ${user.collections.activities.count} 
                                (Types: ${user.collections.activities.types.join(', ')})
                            </div>
                            
                            <div class="collection-info">
                                <strong>üîë Keywords:</strong> ${user.collections.keywords.count}
                                ${user.collections.keywords.sample.length > 0 ? 
                                    `<br>Sample: ${user.collections.keywords.sample.map(k => k.keyword).join(', ')}` : ''}
                            </div>
                            
                            <div class="collection-info">
                                <strong>üè¢ Competitors:</strong> ${user.collections.competitors.count}
                                ${user.collections.competitors.domains.length > 0 ? 
                                    `<br>Domains: ${user.collections.competitors.domains.join(', ')}` : ''}
                            </div>
                            
                            <div class="collection-info">
                                <strong>üìÑ Content Analyses:</strong> ${user.collections.contentAnalyses.count}
                            </div>
                            
                            <div class="collection-info">
                                <strong>üèÜ Achievements:</strong> ${user.collections.achievements.count}
                                ${user.collections.achievements.types.length > 0 ? 
                                    `<br>Types: ${user.collections.achievements.types.join(', ')}` : ''}
                            </div>
                        </div>
                    `).join('');
                    
                } else {
                    output.textContent = '‚ùå Review failed: ' + (result.error || 'Unknown error');
                }
            } catch (error) {
                output.textContent = '‚ùå Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
